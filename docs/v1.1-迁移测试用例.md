# v1.1 数据库迁移测试用例

## 📋 测试概述

本文档定义了v1.1数据库迁移后必须通过的测试用例。**如果任何测试失败，必须立即回滚迁移。**

---

## ✅ 测试用例列表

### 测试1：新表创建成功

| 项目 | 操作步骤 | 预期结果 | 测试方法 |
|------|---------|---------|---------|
| **表存在性** | Supabase控制台查看表列表 | 存在`courses`, `user_courses`, `course_words`, `practice_records` 4张表 | 自动化脚本检查 |
| **表结构完整** | 检查courses表字段 | 包含`id`, `title`, `slug`, `category`, `total_words`等字段 | SQL查询验证 |

**通过标准**：4张表全部存在，且核心字段完整。

---

### 测试2：现有表数据未丢失（v1.0数据完整性）

| 项目 | 操作步骤 | 预期结果 | 测试方法 |
|------|---------|---------|---------|
| **words表数据** | 查询words表记录数 | 记录数 > 0，且数据完整 | `SELECT count(*) FROM words` |
| **words表结构** | 检查words表字段 | 包含原有的8个字段（id, chinese, pinyin, english, scene, example, category, frequency） | 字段名称对比 |
| **user_progress表** | 查询user_progress表 | 表存在，记录数不变（可能为0） | `SELECT count(*) FROM user_progress` |
| **记录完整性** | 随机抽取1条words记录 | chinese, pinyin, english字段均有值 | 抽样检查 |
| **关联完整性** | 检查user_progress与words的关联 | LEFT JOIN能正确查询到汉字 | SQL JOIN测试 |

**通过标准**：
- words表数据量不变
- user_progress表数据量不变
- 所有字段保留，无数据丢失

---

### 测试3：外键关联有效

| 测试项 | 操作步骤 | 预期结果 | 通过标准 |
|--------|---------|---------|---------|
| **course_words → courses外键** | 尝试插入不存在的`course_id` | 插入失败，报错`foreign key violation` | 捕获外键错误 |
| **course_words → words外键** | 尝试插入不存在的`word_id` (如99999999) | 插入失败，报错`foreign key violation` | 捕获外键错误 |
| **user_courses唯一约束** | 尝试插入重复的`(user_id, course_id)` | 插入失败，报错`unique constraint violation` | 捕获唯一性错误 |

**测试SQL示例**：

```sql
-- 测试外键约束（应该失败）
INSERT INTO course_words (course_id, word_id, "order")
VALUES (99999, 1, 1);
-- 预期: ERROR: insert or update on table "course_words" violates foreign key constraint

-- 测试唯一约束（第二次应该失败）
INSERT INTO user_courses (user_id, course_id, progress)
VALUES ('test-user-id', 1, 0);

INSERT INTO user_courses (user_id, course_id, progress)
VALUES ('test-user-id', 1, 0);
-- 预期: ERROR: duplicate key value violates unique constraint "user_courses_user_course_unique"
```

**通过标准**：
- 外键约束正确拦截非法数据
- 唯一约束正确拦截重复数据
- 错误代码为`23503`（外键）或`23505`（唯一性）

---

### 测试4：索引创建成功

| 测试项 | 检查内容 | 预期结果 |
|--------|---------|---------|
| **索引数量** | 查询新表的索引数量 | 至少8个索引 |
| **关键索引** | 验证`courses_category_idx`等存在 | 核心查询索引已创建 |

**验证SQL**：

```sql
SELECT tablename, indexname
FROM pg_indexes
WHERE schemaname = 'public'
  AND tablename IN ('courses', 'user_courses', 'course_words', 'practice_records')
ORDER BY tablename, indexname;
```

**预期索引列表**：
- `courses_category_idx`
- `courses_slug_idx`
- `user_courses_user_id_idx`
- `user_courses_course_id_idx`
- `course_words_course_id_idx`
- `course_words_order_idx`
- `practice_records_user_id_idx`
- `practice_records_course_id_idx`
- `practice_records_mode_idx`
- `practice_records_created_at_idx`

---

## 🚀 执行测试

### 方法1：一键执行（推荐）

在项目根目录运行：

```bash
bash scripts/migrate-and-test.sh
```

这个脚本会：
1. ✅ 提醒你备份数据库
2. ✅ 执行数据库迁移
3. ✅ 自动运行所有测试
4. ✅ 提供回滚方案（如果失败）
5. ✅ 可选创建示例课程数据

### 方法2：分步执行

如果需要更细粒度的控制：

```bash
# 步骤1: 执行迁移
npm run db:migrate

# 步骤2: 运行测试
npm run db:test

# 步骤3: 创建课程数据（可选）
npm run seed:courses
```

---

## ❌ 测试失败处理

### 场景1：新表创建失败

**现象**：
```
❌ 表 "courses" 存在
   表未找到，迁移可能失败
```

**原因**：迁移SQL未正确执行

**解决方案**：
1. 检查`DATABASE_URL`环境变量
2. 检查Supabase项目状态
3. 重新运行`npm run db:migrate`

---

### 场景2：v1.0数据丢失

**现象**：
```
❌ words表数据完整
   找到 0 条单词记录
```

**原因**：数据被意外删除（严重错误！）

**解决方案**：
1. ⚠️ **立即停止所有操作**
2. 在Supabase控制台恢复备份
3. 检查迁移SQL是否包含`DROP TABLE`（不应该有）
4. 联系技术支持

---

### 场景3：外键约束未生效

**现象**：
```
❌ course_words -> courses外键约束
   允许插入不存在的course_id，外键约束未生效
```

**原因**：外键约束创建失败

**解决方案**：
1. 手动执行外键创建SQL：
```sql
ALTER TABLE course_words 
ADD CONSTRAINT course_words_course_id_fk 
FOREIGN KEY (course_id) 
REFERENCES courses(id) 
ON DELETE CASCADE;
```

2. 重新运行测试验证

---

## 🔄 回滚迁移

如果测试失败且无法修复，执行回滚：

### 方法1：恢复Supabase备份（推荐）

1. 登录Supabase Dashboard
2. Database → Backups
3. 选择迁移前的备份
4. 点击"Restore"

### 方法2：手动删除新表

在Supabase SQL编辑器执行：

```sql
-- 按依赖顺序删除表
DROP TABLE IF EXISTS practice_records CASCADE;
DROP TABLE IF EXISTS course_words CASCADE;
DROP TABLE IF EXISTS user_courses CASCADE;
DROP TABLE IF EXISTS courses CASCADE;
```

**验证回滚成功**：

```sql
-- 确认新表已删除
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('courses', 'user_courses', 'course_words', 'practice_records');
-- 应该返回0行

-- 确认v1.0表仍存在
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('words', 'user_progress');
-- 应该返回2行
```

---

## 📊 测试报告示例

**成功案例**：

```
🧪 开始执行v1.1迁移测试...
============================================================

📋 测试1: 新表创建成功
------------------------------------------------------------
  ✅ 表 "courses" 存在
     表已成功创建
  ✅ 表 "user_courses" 存在
     表已成功创建
  ✅ 表 "course_words" 存在
     表已成功创建
  ✅ 表 "practice_records" 存在
     表已成功创建
  ✅ courses表包含所有必需字段
     字段完整

📋 测试2: 现有表数据未丢失（v1.0数据完整性）
------------------------------------------------------------
  ✅ words表数据完整
     找到 5234 条单词记录
  ✅ words表结构未被修改
     所有原始字段保留
  ✅ words表记录完整性
     示例: "你好" (nǐ hǎo)
  ✅ user_progress表数据完整
     找到 42 条学习进度记录
  ✅ user_progress与words表关联完整
     用户 a1b2c3d4... 的进度记录正常

📋 测试3: 外键约束生效
------------------------------------------------------------
  ✅ course_words -> courses外键约束
     正确拦截非法course_id
  ✅ course_words -> words外键约束
     正确拦截非法word_id
  ✅ user_courses唯一约束
     正确拦截重复记录

📋 测试4: 索引创建成功
------------------------------------------------------------
  ✅ 新表索引创建
     创建了 10 个索引（预期至少8个）

============================================================
📊 测试结果总结:
============================================================
✅ 通过: 14 项
❌ 失败: 0 项

🎉 所有测试通过！迁移成功！

✅ v1.0数据完整无损
✅ v1.1新表创建成功
✅ 外键约束正常工作
✅ 索引创建完成

🚀 可以继续进行v1.1功能开发了！
```

---

## 📝 测试检查清单

在继续v1.1开发前，确认以下所有项：

- [ ] 已在Supabase创建数据库备份
- [ ] 成功执行`npm run db:migrate`（无错误）
- [ ] 成功执行`npm run db:test`（所有测试通过）
- [ ] Supabase控制台可以看到4张新表
- [ ] v1.0功能正常（访问`/wordbanks/business`可用）
- [ ] words表记录数不变
- [ ] user_progress表记录数不变
- [ ] 外键约束测试通过
- [ ] 索引创建完成

---

## 🆘 技术支持

如遇到问题，请提供：

1. 完整的错误日志
2. `npm run db:test`的输出
3. Supabase项目ID
4. PostgreSQL版本

---

*文档版本：v1.1 | 最后更新：2025-10-31*


