# 问题修复说明

## 修复的问题

### 1. ✅ Google登录后没有保留登录状态

**问题原因**：
- OAuth回调路由在重定向时没有正确传递cookie
- `exchangeCodeForSession`设置的cookie没有包含在重定向响应中

**修复方案**：
- 修改 `app/auth/callback/route.ts`
- 在设置cookie时同时设置到response对象中
- 确保重定向时使用包含cookie的response

**关键修改**：
```typescript
// 创建响应对象（用于设置cookie）
let response = NextResponse.redirect(new URL(redirectTo, requestUrl.origin));

// 在设置cookie时同时设置到response中
set(name: string, value: string, options: any) {
  cookieStore.set({ name, value, ...options });
  response.cookies.set({ name, value, ...options }); // 关键修复
}
```

### 2. ✅ 恢复邮箱登录和注册功能

**修复内容**：
- 恢复邮箱/密码登录功能
- 恢复邮箱注册功能
- 添加Google登录按钮（保留两种登录方式）
- 添加邮箱重复检查

**关键功能**：
- 邮箱登录：`signInWithPassword`
- 邮箱注册：`signUp` + 邮箱重复检查
- Google登录：`signInWithOAuth`
- 模式切换：登录/注册切换

### 3. ✅ 邮箱重复检查

**修复方案**：
- 在注册时捕获Supabase返回的错误
- 检查错误消息是否包含"already registered"或"already exists"
- 显示友好的错误提示："该邮箱已被注册，请直接登录或使用其他邮箱"

**实现**：
```typescript
if (signupError.message.includes('already registered') || 
    signupError.message.includes('already exists')) {
  setError('该邮箱已被注册，请直接登录或使用其他邮箱');
}
```

### 4. ✅ Google登录后更新users表

**修复内容**：
- 无论是否有invite_code，Google登录后都检查并更新users表
- 如果users表中没有记录，自动创建一条（默认3次复习额度）

**实现位置**：`app/auth/callback/route.ts`

### 5. ✅ 许愿池和邀请码功能显示

**确认**：
- ✅ `WishForm`组件已创建：`components/WishForm.tsx`
- ✅ `InviteSection`组件已创建：`app/profile/invite-section.tsx`
- ✅ 已集成到课程页：`app/courses/CoursesPageClient.tsx`（第96行和第302行）
- ✅ 已集成到个人中心：`app/profile/page.tsx`（第215行）

**如果看不到功能，请检查**：
1. 开发服务器是否已重启：`npm run dev`
2. 浏览器是否已刷新（Ctrl+F5 或 Cmd+Shift+R 强制刷新）
3. 是否已登录（邀请码功能需要登录）
4. 浏览器控制台是否有错误（F12查看）

---

## 测试步骤

### 测试1：邮箱登录和注册

1. 访问：`http://localhost:3000/login`
2. **测试注册**：
   - 切换到"Sign up"模式
   - 输入已存在的邮箱 → 应该显示"该邮箱已被注册"
   - 输入新邮箱 → 应该成功注册
3. **测试登录**：
   - 切换到"Log in"模式
   - 输入正确的邮箱和密码 → 应该成功登录并跳转

### 测试2：Google登录

1. 访问：`http://localhost:3000/login`
2. 点击"Continue with Google"按钮
3. 完成Google OAuth授权
4. **验证**：
   - ✅ 登录成功后跳转到 `/courses`
   - ✅ 刷新页面后仍然保持登录状态
   - ✅ 访问 `/profile` 可以看到用户信息

### 测试3：许愿池功能

1. 访问：`http://localhost:3000/courses`
2. **检查顶部横幅**：
   - 应该看到紫色渐变横幅："想要什么课程？告诉我们！"
   - 点击"许愿新课程"按钮
3. **检查底部按钮**：
   - 滚动到页面底部
   - 应该看到"🌟 许愿新课程"按钮
4. **测试提交**：
   - 填写表单并提交
   - 应该显示成功动画

### 测试4：邀请码功能

1. **登录后**访问：`http://localhost:3000/profile`
2. **检查邀请码卡片**：
   - 滚动到页面下方（在成就展示下方）
   - 应该看到"🎁 邀请好友"卡片
   - 显示"已邀请 X 人"（大数字）
3. **测试生成链接**：
   - 点击"邀请朋友"按钮
   - 应该立即显示邀请链接
   - 点击"复制链接"按钮测试复制功能

---

## 如果功能仍然不显示

### 检查清单

1. **开发服务器状态**：
   ```bash
   # 停止服务器（Ctrl+C）
   # 重新启动
   npm run dev
   ```

2. **浏览器缓存**：
   - 按 `Ctrl+Shift+R` (Windows/Linux) 或 `Cmd+Shift+R` (Mac) 强制刷新
   - 或清除浏览器缓存

3. **检查控制台错误**：
   - 按 `F12` 打开开发者工具
   - 查看 Console 标签页是否有错误
   - 查看 Network 标签页，确认文件是否加载成功

4. **检查文件是否存在**：
   ```bash
   ls -la components/WishForm.tsx
   ls -la app/profile/invite-section.tsx
   ```

5. **检查导入路径**：
   - `components/WishForm.tsx` 应该从 `@/components/WishForm` 导入
   - `app/profile/invite-section.tsx` 应该从 `./invite-section` 导入

---

## 修复文件清单

- ✅ `app/auth/callback/route.ts` - 修复OAuth session持久化
- ✅ `app/login/LoginForm.tsx` - 恢复邮箱登录/注册，添加Google登录按钮
- ✅ `components/WishForm.tsx` - 许愿池组件（已存在）
- ✅ `app/profile/invite-section.tsx` - 邀请码组件（已存在）
- ✅ `app/courses/CoursesPageClient.tsx` - 已集成WishForm（已存在）
- ✅ `app/profile/page.tsx` - 已集成InviteSection（已存在）

---

## 验证修复

运行自动化测试：
```bash
npm run test:wish-invite
```

所有测试应该通过（15/15）。

