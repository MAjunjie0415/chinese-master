# 许愿池和邀请码功能 - 手动测试指南

## 🚀 准备工作

### 1. 启动开发服务器

```bash
# 确保在项目根目录
cd /Users/mima0000/chinese-master

# 启动开发服务器
npm run dev
```

服务器启动后，访问：`http://localhost:3000`

### 2. 准备测试账号

- **主账号**：用于测试邀请码生成
- **测试账号**：用于测试邀请码使用（可以使用Google登录创建新账号）

---

## 📋 测试1：许愿池表单提交

### 测试步骤

1. **访问课程页面**
   - 打开浏览器，访问：`http://localhost:3000/courses`
   - 检查页面顶部是否有**紫色渐变横幅**："想要什么课程？告诉我们！"

2. **打开许愿表单**
   - 点击横幅中的 **"许愿新课程"** 按钮
   - 或者滚动到页面底部，点击 **"🌟 许愿新课程"** 按钮
   - 应该弹出Modal（全屏遮罩 + 居中卡片）

3. **填写表单**
   - **课程标题**（必填）：例如 `Medical Chinese（医疗汉语）`
   - **类别**：选择 `商务汉语`、`旅游汉语`、`考试HSK`、`文化兴趣` 或 `其他`
   - **详细描述**（可选）：例如 `希望学习医疗场景下的中文表达`

4. **提交表单**
   - 点击 **"提交愿望"** 按钮
   - **预期结果**：
     - ✅ 立即显示成功动画（绿色✅图标）
     - ✅ 显示文字："感谢您的建议！我们会认真考虑"
     - ✅ 3秒后自动关闭Modal
     - ✅ 表单已清空

5. **验证数据保存**
   - 打开Supabase Dashboard → Table Editor → `user_wishes` 表
   - 检查是否有新记录
   - 验证字段：`title`、`category`、`description`、`status`（应为 `pending`）

### ✅ 测试通过标准

- [ ] 横幅和按钮正常显示
- [ ] Modal正常弹出和关闭
- [ ] 表单验证正常（标题为空时提示错误）
- [ ] 提交后显示成功动画
- [ ] 数据成功保存到数据库

---

## 📋 测试2：邀请码生成和复制

### 测试步骤

1. **登录系统**
   - 访问：`http://localhost:3000/login`
   - 使用Google登录（或已有账号）

2. **访问个人中心**
   - 登录后访问：`http://localhost:3000/profile`
   - 滚动到页面下方，找到 **"🎁 邀请好友"** 卡片

3. **检查初始状态**
   - **已邀请人数**：应该显示 `0`（大数字）
   - **说明文字**：显示 "邀请朋友注册，你们都能获得3次复习额度"

4. **生成邀请链接**
   - 点击 **"邀请朋友"** 按钮
   - **预期结果**：
     - ✅ 立即显示邀请链接（格式：`http://localhost:3000/login?invite_code=XXXXXX`）
     - ✅ 显示 **"📋 复制链接"** 按钮
     - ✅ 显示 **"生成新链接"** 按钮

5. **复制链接**
   - 点击 **"📋 复制链接"** 按钮
   - **预期结果**：
     - ✅ 按钮文字变为 **"✅ 已复制！"**
     - ✅ 2秒后恢复为 **"📋 复制链接"**
   - 验证：打开记事本，按 `Ctrl+V`（或 `Cmd+V`），应该能粘贴链接

6. **验证数据保存**
   - 打开Supabase Dashboard → Table Editor → `invite_codes` 表
   - 检查是否有新记录
   - 验证字段：
     - `code`：6位大写字母/数字
     - `generated_by`：当前用户ID
     - `is_used`：应为 `false`
     - `used_by`：应为 `null`

### ✅ 测试通过标准

- [ ] 邀请码卡片正常显示
- [ ] 点击按钮后立即生成链接（乐观更新）
- [ ] 复制功能正常工作
- [ ] 邀请码成功保存到数据库
- [ ] 已邀请人数统计正确（初始为0）

---

## 📋 测试3：Google登录 + invite_code流程

### 测试步骤

#### 步骤1：生成邀请链接（使用主账号）

1. 使用**主账号**登录
2. 访问：`http://localhost:3000/profile`
3. 点击 **"邀请朋友"** 生成邀请链接
4. 复制邀请链接（例如：`http://localhost:3000/login?invite_code=ABC123`）

#### 步骤2：使用邀请链接注册（新账号）

1. **打开新浏览器窗口/隐身模式**
   - 这样可以模拟新用户
   - 或者使用另一个Google账号

2. **访问邀请链接**
   - 粘贴复制的邀请链接到地址栏
   - 访问：`http://localhost:3000/login?invite_code=ABC123`

3. **检查登录页**
   - **预期结果**：
     - ✅ 只显示 **"Continue with Google"** 按钮（没有邮箱/密码输入框）
     - ✅ 显示紫色提示框："🎁 使用邀请码注册，您将获得3次复习额度"

4. **完成Google登录**
   - 点击 **"Continue with Google"** 按钮
   - 选择Google账号（使用新账号或测试账号）
   - 完成OAuth授权

5. **验证登录成功**
   - **预期结果**：
     - ✅ 登录成功后跳转到 `/courses` 页面
     - ✅ 没有错误提示

#### 步骤3：验证邀请码处理

1. **检查invite_codes表**
   - 打开Supabase Dashboard → Table Editor → `invite_codes` 表
   - 找到刚才使用的邀请码（`code = ABC123`）
   - **验证字段**：
     - ✅ `is_used`：应为 `true`
     - ✅ `used_by`：应为新用户的ID
     - ✅ `used_at`：应有时间戳

2. **检查邀请人额度（主账号）**
   - 打开Supabase Dashboard → Table Editor → `users` 表
   - 找到主账号的记录（`id = 主账号ID`）
   - **验证字段**：
     - ✅ `invite_quota`：应该增加3（例如：从3变为6）
     - ✅ `invited_count`：应该增加1（例如：从0变为1）

3. **检查新用户额度**
   - 在 `users` 表中找到新用户的记录（`id = 新用户ID`）
   - **验证字段**：
     - ✅ `invite_quota`：应为 `3`（新用户获得3次复习额度）
     - ✅ `invited_count`：应为 `0`

4. **验证个人中心显示（主账号）**
   - 使用主账号访问：`http://localhost:3000/profile`
   - 检查 **"已邀请人数"**：应该显示 `1`（大数字）

### ✅ 测试通过标准

- [ ] 邀请链接正确传递invite_code参数
- [ ] 登录页显示邀请码提示
- [ ] Google登录流程正常
- [ ] 登录成功后正确跳转
- [ ] invite_codes表正确更新（is_used=true）
- [ ] 邀请人获得3次复习额度
- [ ] 新用户获得3次复习额度
- [ ] 已邀请人数统计正确更新

---

## 🐛 常见问题排查

### 问题1：许愿表单提交失败

**可能原因**：
- 用户未登录
- 网络连接问题
- Supabase RLS策略限制

**排查步骤**：
1. 检查浏览器控制台（F12）是否有错误
2. 检查是否已登录（访问 `/profile` 确认）
3. 检查Supabase Dashboard → Authentication → Policies

### 问题2：邀请码生成后无法复制

**可能原因**：
- 浏览器权限问题
- Clipboard API不支持

**排查步骤**：
1. 检查浏览器控制台是否有错误
2. 尝试手动复制链接文本
3. 使用Chrome或Edge浏览器（Clipboard API支持更好）

### 问题3：Google登录后invite_code未处理

**可能原因**：
- OAuth回调URL配置错误
- invite_code参数丢失
- 数据库操作失败

**排查步骤**：
1. 检查浏览器地址栏，确认invite_code参数存在
2. 检查Supabase Dashboard → Authentication → URL Configuration
3. 检查浏览器控制台和服务器日志
4. 验证 `app/auth/callback/route.ts` 是否正确处理invite_code

### 问题4：users表数据未更新

**可能原因**：
- users表不存在（需要执行SQL脚本）
- RLS策略限制
- 用户ID类型不匹配

**排查步骤**：
1. 确认 `public.users` 表已创建
2. 检查RLS策略是否正确配置
3. 验证 `id` 字段类型为 `uuid`（不是 `text`）

---

## 📊 测试检查清单

### 许愿池功能
- [ ] 横幅正常显示
- [ ] Modal正常弹出
- [ ] 表单验证正常
- [ ] 提交成功动画
- [ ] 数据保存到数据库

### 邀请码功能
- [ ] 卡片正常显示
- [ ] 生成链接正常
- [ ] 复制功能正常
- [ ] 数据保存到数据库
- [ ] 已邀请人数统计正确

### Google登录 + invite_code
- [ ] 邀请链接正确
- [ ] 登录页显示提示
- [ ] 登录流程正常
- [ ] invite_codes表更新
- [ ] users表额度更新
- [ ] 统计数据更新

---

## 🎯 测试完成标准

所有测试项都通过后，功能即可投入使用！

如果遇到问题，请：
1. 检查浏览器控制台错误
2. 检查Supabase Dashboard日志
3. 查看测试报告文档
4. 运行自动化测试：`npm run test:wish-invite`

