# 数据库连接问题修复指南

## 问题描述

执行 `npx drizzle-kit push` 时遇到错误：
```
Error: getaddrinfo ENOTFOUND db.gfrtuxvcqajvtyfhpujv.supabase.co
```

## 原因分析

1. Supabase项目可能还未完全初始化
2. 数据库连接URL格式不正确
3. 网络无法解析Supabase数据库主机名

## 解决步骤

### 1. 验证Supabase项目状态

1. 登录 https://supabase.com
2. 进入你的项目仪表板
3. 检查项目状态：
   - ✅ 状态应为 "Active" (绿色)
   - ⏳ 如果是"Starting"，需要等待几分钟
   - ❌ 如果是"Paused"，需要恢复项目

### 2. 获取正确的数据库连接字符串

**推荐方式：使用Session Pooler连接**

1. 在Supabase项目中：`Settings` → `Database`
2. 找到 **"Connection string"** 部分
3. 选择 **"Session pooler"** 选项卡（推荐用于serverless和Drizzle）
4. 复制连接字符串，格式示例：
   ```
   postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres
   ```

**注意：**
- `[project-ref]` - 你的项目引用ID
- `[password]` - 你的数据库密码（需要手动替换）
- `[region]` - 数据库区域（如us-east-1）

### 3. 更新.env.local文件

打开 `.env.local` 文件，更新 `DATABASE_URL`：

```bash
# 旧的（Direct connection - 可能无法连接）
DATABASE_URL="postgresql://postgres:majunjie1215@db.gfrtuxvcqajvtyfhpujv.supabase.co:5432/postgres"

# 新的（Session pooler - 推荐）
DATABASE_URL="postgresql://postgres.[project-ref]:[your-password]@aws-0-[region].pooler.supabase.com:6543/postgres"
```

**重要提示：**
- 确保密码正确，不要包含方括号 `[]`
- 保存文件后，重启开发服务器（如果正在运行）

### 4. 重新执行数据库迁移

```bash
cd /Users/mima0000/chinese-master
npx drizzle-kit push
```

如果成功，应该看到：
```
✓ Pulling schema from database...
✓ Pushing schema to database...
Everything is up to date
```

## 验证数据库连接

### 方法1：使用psql命令行工具

```bash
psql "postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres"
```

如果连接成功，会进入PostgreSQL命令行。

### 方法2：在Supabase仪表板中检查

1. 进入 Supabase 项目
2. 点击左侧 `Table Editor`
3. 如果迁移成功，应该能看到 `words` 和 `user_progress` 两个表

## 常见问题

### Q: 密码中包含特殊字符怎么办？

A: 需要对密码进行URL编码：
- `@` → `%40`
- `#` → `%23`
- `$` → `%24`
- `&` → `%26`
- 或使用在线工具：https://www.urlencoder.org/

### Q: 仍然无法连接怎么办？

A: 尝试以下方法：
1. 检查网络连接（是否能访问 https://supabase.com）
2. 尝试使用 "Transaction pooler" 而不是 "Session pooler"
3. 检查防火墙是否阻止了数据库连接
4. 联系Supabase支持

### Q: 如何查看项目引用ID (project-ref)?

A: 
1. 在Supabase仪表板中，点击 `Settings` → `General`
2. 找到 "Reference ID" 或在项目URL中：
   `https://supabase.com/dashboard/project/[your-project-ref]`

## 下一步

修复连接问题后，继续执行：
1. ✅ 验证表已创建：`words` 和 `user_progress`
2. ✅ 导入词库数据到 `words` 表
3. ✅ 继续开发词库页面和背单词功能

---

**修复完成后，请删除本文档或将其移至备份位置。**

